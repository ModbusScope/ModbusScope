name: Code quality analysis

on:
  pull_request:
    # Sequence of patterns matched against refs/heads
    branches:    
      - master
  push:
    branches:
      - master

jobs:
  coverity:
    runs-on: ubuntu-latest
    container: docker://jgeudens/qt-linux:6.4.1_build_1
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Start display server
      run: bash /start.sh &

    - name: Prepare environment for Ninja build with coverage
      run: cmake . -GNinja -DUSE_GCOV=ON

    - name: Analyse (Coverity)
      uses: vapier/coverity-scan-action@v1
      with:
        email: ${{ secrets.MAIL_ADDRESS }}
        token: ${{ secrets.COVERITY_SCAN_TOKEN }}
        command: ninja

    - name: Generate gcovr coverage report
      run: |
        ctest
        gcovr -x > cobertura.xml

    - name: Run codacy-coverage-reporter
      uses: codacy/codacy-coverage-reporter-action@v1
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        language: 'CPP'
        coverage-reports: cobertura.xml
